<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字轉PNG轉換器</title>
    <style>
        /* 載入您指定的 .woff2 格式字體 */
        @font-face {
          font-family: 'Rage Italic';
          src: url('./fonts/RageItalic.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Avenir Next Condensed';
          src: url('./fonts/AvenirNextCondensed.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Taipei Sans TC Beta';
          src: url('./fonts/TaipeiSansTCBeta.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Noto Sans CJK TC';
          src: url('./fonts/NotoSansCJKtc.woff2') format('woff2');
        }
        @font-face {
          font-family: '微軟正黑體';
          src: url('./fonts/MicrosoftJhengHei.woff2') format('woff2');
        }

        /* 通用樣式 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans CJK TC', '微軟正黑體', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; padding: 20px; background: #f8f9ff; border-radius: 10px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-top: 5px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .info-box { padding: 10px; background: #fff8e1; border-radius: 8px; font-size: 13px; color: #f57c00; margin-top: 15px; }
        .char-counter { text-align: right; font-size: 14px; margin-top: 5px; color: #666; }
        .char-counter.error { color: #ff5252; font-weight: bold; }
        .checkbox-group { display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-top: 10px; }
        input[type="checkbox"] { width: auto; margin-right: 8px; }
        
        #canvasWrapper {
            position: relative;
            margin: 20px auto 50px auto; /* 增加底部 margin 給放大後的空間 */
            max-width: 100%;
            display: inline-block;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            /* ========== START: 放大 30% ========== */
            transform: scale(1.3);
            transform-origin: center;
            /* ========== END: 放大 30% ========== */
        }
        #textCanvas, #guideCanvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        #textCanvas { z-index: 1; }
        #guideCanvas { z-index: 2; pointer-events: none; }
        
        .font-mode-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .font-mode-btn { flex: 1; padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .font-mode-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .font-settings { display: none; }
        .font-settings.active { display: block; }
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 15px; }
        .template-card { padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer; text-align: center; transition: all 0.3s; position: relative; min-height: 140px; }
        .template-card:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .template-card.active { border-color: #667eea; background: #f0f2ff; }
        .add-template-card { padding: 15px; background: #fff; border: 2px dashed #667eea; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .add-template-card:hover { background: #f0f2ff; border-color: #764ba2; transform: translateY(-2px); }
        .delete-btn, .edit-btn { position: absolute; top: 5px; width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; display: none; color: white; font-size: 12px; }
        .delete-btn { right: 5px; background: #ff5252; }
        .edit-btn { right: 35px; background: #667eea; }
        .template-card:hover .delete-btn, .template-card:hover .edit-btn { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 3% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; transition: opacity 0.3s; }
        #loadingBox { width: 90%; max-width: 400px; text-align: center; }
        #loadingMessage { font-size: 1.2em; margin-bottom: 15px; }
        #progressBarContainer { width: 100%; background: #444; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        #progressBar { width: 0%; height: 10px; background: #667eea; transition: width 0.2s ease-out; }
        #fontStatus { font-size: 0.9em; height: 20px; color: #ccc; }

        .stepper { display: flex; align-items: center; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-top: 5px; }
        .stepper:focus-within { border-color: #667eea; }
        .stepper input { width: 100%; border: none; text-align: center; margin: 0; padding: 8px 0; -moz-appearance: textfield; }
        .stepper input::-webkit-outer-spin-button, .stepper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stepper-btn { background: #f0f2ff; border: none; cursor: pointer; font-size: 18px; color: #667eea; font-weight: bold; transition: background 0.2s; width: 34px; height: 38px; flex-shrink: 0; user-select: none; }
        .stepper-btn:hover { background: #dfe3ff; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div id="loadingBox">
            <div id="loadingMessage">正在載入字體...</div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
            <div id="fontStatus">(0/5)</div>
        </div>
    </div>

    <div class="container">
        <div class="header"><h1>✨ 文字轉PNG轉換器</h1><p>自定義模板 • 22字元限制 • 透明背景 • 中英分離字體</p></div>
        <div class="content">
            <div class="section"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><div class="section-title">🎨 自定義模板</div><div><button class="btn btn-secondary" onclick="exportTemplates()">📤 匯出</button><button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="margin: 0 10px;">📥 匯入</button><input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTemplates(event)"><button class="btn btn-primary" onclick="openTemplateModal()">+ 新增模板</button></div></div><div class="template-grid" id="templateGrid"><div class="add-template-card" onclick="openTemplateModal()"><div style="font-size: 48px; color: #667eea;">+</div><div style="color: #667eea; margin-top: 10px;">新增模板</div></div></div><div class="info-box">💡 <strong>提示：</strong>點擊模板套用所有設定，再次點擊取消選擇。當前使用模板：<span id="currentTemplate">無</span></div></div>
            <div class="section"><div class="section-title">輸入文字（最多22字元）</div><textarea id="textInput" placeholder="請輸入要轉換的文字..." maxlength="50" style="height: 100px;">My Cute Jigglypuff</textarea><div class="char-counter" id="charCounter">14 / 22</div></div>
            <div class="section"><div class="section-title">字體設定</div><div class="font-mode-toggle"><button class="font-mode-btn active" onclick="switchFontMode('single', event)">統一字體</button><button class="font-mode-btn" onclick="switchFontMode('dual', event)">中英分離</button></div>
                <div id="singleFontSettings" class="font-settings active"><div><label>字體</label><select id="fontFamily"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'微軟正黑體', sans-serif">微軟正黑體</option><option value="Arial, sans-serif">Arial (系統)</option></select></div></div>
                <div id="dualFontSettings" class="font-settings"><div class="grid-2"><div><label>英文字體</label><select id="englishFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option><option value="Arial, sans-serif">Arial (系統)</option></select></div><div><label>中文字體</label><select id="chineseFont"><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'微軟正黑體', sans-serif">微軟正黑體</option></select></div></div></div>
            </div>
            <div class="section"><div class="section-title">輸出設定</div>
                <div class="grid-2" style="margin-bottom: 15px;">
                    <div><label>字級 (px)</label><input type="number" id="fontSize" value="42.34" min="8" max="200" step="0.01"></div>
                    <div><label>字距 (px)</label><input type="number" id="letterSpacing" value="15" min="-10" max="500"></div>
                    <div><label>文字顏色</label><input type="color" id="textColor" value="#000000" style="padding: 5px; height: 42px;"></div>
                </div>
                <div class="grid-2" style="margin-bottom: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <div><label>中文 Y 軸偏移 (px)</label><input type="number" id="chineseYOffset" value="0" step="0.5"></div>
                    <div><label>英文 Y 軸偏移 (px)</label><input type="number" id="englishYOffset" value="0" step="0.5"></div>
                </div>
                <div class="grid-4">
                    <div>
                        <label>上邊距 (Top)</label>
                        <div class="stepper">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingTop', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingTop', -1)" ontouchend="stopAdjusting()">-</button>
                            <input type="number" id="paddingTop" value="10" max="200">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingTop', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingTop', 1)" ontouchend="stopAdjusting()">+</button>
                        </div>
                    </div>
                    <div>
                        <label>下邊距 (Bottom)</label>
                        <div class="stepper">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingBottom', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingBottom', -1)" ontouchend="stopAdjusting()">-</button>
                            <input type="number" id="paddingBottom" value="10" max="200">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingBottom', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingBottom', 1)" ontouchend="stopAdjusting()">+</button>
                        </div>
                    </div>
                    <div>
                        <label>左邊距 (Left)</label>
                        <div class="stepper">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingLeft', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingLeft', -1)" ontouchend="stopAdjusting()">-</button>
                            <input type="number" id="paddingLeft" value="10" max="200">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingLeft', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingLeft', 1)" ontouchend="stopAdjusting()">+</button>
                        </div>
                    </div>
                    <div>
                        <label>右邊距 (Right)</label>
                        <div class="stepper">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingRight', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingRight', -1)" ontouchend="stopAdjusting()">-</button>
                            <input type="number" id="paddingRight" value="10" max="200">
                            <button class="stepper-btn" onmousedown="startAdjusting('paddingRight', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="startAdjusting('paddingRight', 1)" ontouchend="stopAdjusting()">+</button>
                        </div>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rotate180"><label for="rotate180">旋轉180度</label>
                    <input type="checkbox" id="showAlignmentGuides" style="margin-left: 20px;" checked><label for="showAlignmentGuides">顯示對齊輔助線</label>
                </div>
                <div class="info-box">📌 <strong>提示：</strong>如果字體被裁切，請試著增加邊距。輔助線可協助對齊中英文字。</div>
            </div>
            <div class="section" style="text-align: center;"> <div class="section-title" style="text-align: left;">預覽與下載</div>
                <div id="canvasWrapper">
                    <canvas id="textCanvas"></canvas>
                    <canvas id="guideCanvas"></canvas>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;" id="sizeInfo">尺寸資訊</div>

                <div style="max-width: 400px; margin: 20px auto 0 auto;">
                    <label for="shippingNumberInput" style="display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #333;">寄件編號 (檔名前綴)</label>
                    <input type="text" id="shippingNumberInput" placeholder="選填，將作為下載檔名的開頭">
                </div>
                <div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" id="downloadBtn" onclick="downloadPNG()">下載 PNG</button></div>
            </div>
        </div>
    </div>
    <div id="templateModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal()">&times;</span><h2 style="margin-bottom: 20px;">📝 模板設定</h2><input type="hidden" id="editIndex" value="-1"><div style="margin-bottom: 15px;"><label>模板名稱 *</label><input type="text" id="templateName" placeholder="例如：網站標題"></div><div style="margin-bottom: 15px;"><label>字體模式</label><select id="templateFontMode"><option value="single">統一字體</option><option value="dual">中英分離</option></select></div>
            <div style="margin-bottom: 15px;"><label>統一字體（統一模式用）</label><select id="templateSingleFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'微軟正黑體', sans-serif">微軟正黑體</option><option value="Arial, sans-serif">Arial (系統)</option></select></div>
            <div class="grid-2" style="margin-bottom: 15px;"><div><label>英文字體（分離模式用）</label><select id="templateEnglishFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option><option value="Arial, sans-serif">Arial (系統)</option></select></div><div><label>中文字體</label><select id="templateChineseFont"><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'微軟正黑體', sans-serif">微軟正黑體</option></select></div></div>
            <div class="grid-2" style="margin-bottom: 15px;">
                <div><label>字級 (px)</label><input type="number" id="templateFontSize" value="42.34" step="0.01"></div>
                <div><label>字距 (px)</label><input type="number" id="templateLetterSpacing" value="15"></div>
                <div><label>文字顏色</label><input type="color" id="templateTextColor" value="#000000"></div>
            </div>
             <div class="grid-4" style="margin-bottom: 15px;">
                <div><label>上邊距</label><input type="number" id="templatePaddingTop" value="10"></div>
                <div><label>下邊距</label><input type="number" id="templatePaddingBottom" value="10"></div>
                <div><label>左邊距</label><input type="number" id="templatePaddingLeft" value="20"></div>
                <div><label>右邊距</label><input type="number" id="templatePaddingRight" value="20"></div>
            </div>
            <div style="margin-bottom: 15px;"><input type="checkbox" id="templateRotate"><label for="templateRotate">旋轉180度</label></div><div style="margin-bottom: 15px;"><label>描述（選填）</label><input type="text" id="templateDesc" placeholder="例如：適用於主標題"></div><div style="margin-top: 20px;"><button class="btn btn-primary" onclick="saveTemplate()">儲存模板</button><button class="btn btn-secondary" onclick="closeModal()" style="margin-left: 10px;">取消</button></div></div></div>

    <script>
        // --- 全域變數 ---
        let templates = [];
        let defaultTemplatesFromFile = [];
        let fontMode = 'single';
        let currentTemplateName = null;
        let adjustTimeout = null;
        let adjustInterval = null;
        
        // --- 初始化 ---
        window.onload = async function() {
            const fontsLoaded = await loadFontsWithProgress();
            if (fontsLoaded) {
                await loadTemplates();
                initApp();
            }
        };

        function initApp() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.opacity = 0;
            setTimeout(() => loadingOverlay.style.display = 'none', 300);
            
            checkCharCount();
            
            const inputs = ['textInput', 'fontSize', 'letterSpacing', 'textColor', 'paddingTop', 'paddingBottom', 'paddingLeft', 'paddingRight', 'fontFamily', 'englishFont', 'chineseFont', 'rotate180', 'chineseYOffset', 'englishYOffset', 'showAlignmentGuides'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                const event = (element.type === 'checkbox' || element.tagName === 'SELECT') ? 'change' : 'input';
                element.addEventListener(event, () => {
                    if (id === 'textInput') checkCharCount();
                    updateCanvas();
                });
            });

            updateCanvas();
        }

        // --- 字體載入 ---
        async function loadFontsWithProgress() {
            const fontsToLoad = [
                { name: 'Rage Italic', url: './fonts/RageItalic.woff2' },
                { name: 'Avenir Next Condensed', url: './fonts/AvenirNextCondensed.woff2' },
                { name: 'Taipei Sans TC Beta', url: './fonts/TaipeiSansTCBeta.woff2' },
                { name: 'Noto Sans CJK TC', url: './fonts/NotoSansCJKtc.woff2' },
                { name: '微軟正黑體', url: './fonts/MicrosoftJhengHei.woff2' }
            ];
            const loadingMessage = document.getElementById('loadingMessage');
            const progressBar = document.getElementById('progressBar');
            const fontStatus = document.getElementById('fontStatus');
            let loadedCount = 0;
            const fontPromises = fontsToLoad.map(fontData => {
                const fontFace = new FontFace(fontData.name, `url(${fontData.url})`);
                return fontFace.load().then(loadedFont => {
                    document.fonts.add(loadedFont);
                    loadedCount++;
                    progressBar.style.width = `${(loadedCount / fontsToLoad.length) * 100}%`;
                    fontStatus.textContent = `(${loadedCount}/${fontsToLoad.length}) ${fontData.name}`;
                }).catch(error => { throw new Error(`字體 "${fontData.name}" 載入失敗，請檢查檔案：${fontData.url}`); });
            });
            try {
                await Promise.all(fontPromises);
                loadingMessage.textContent = "字體載入完成！";
                return true;
            } catch (error) {
                loadingMessage.style.color = '#ff5252';
                loadingMessage.textContent = '錯誤';
                fontStatus.textContent = error.message;
                return false;
            }
        }
        
        // --- 輔助函數 ---
        function adjustPadding(inputId, amount) { const input = document.getElementById(inputId); let value = parseInt(input.value, 10) || 0; value += amount; input.value = value; input.dispatchEvent(new Event('input')); }
        function startAdjusting(inputId, amount) { adjustPadding(inputId, amount); adjustTimeout = setTimeout(() => { adjustInterval = setInterval(() => { adjustPadding(inputId, amount); }, 100); }, 400); }
        function stopAdjusting() { clearTimeout(adjustTimeout); clearInterval(adjustInterval); }
        function switchFontMode(mode, event) { fontMode = mode; document.querySelectorAll('.font-mode-btn').forEach(btn => btn.classList.remove('active')); if (event) event.target.classList.add('active'); document.getElementById('singleFontSettings').classList.toggle('active', mode === 'single'); document.getElementById('dualFontSettings').classList.toggle('active', mode === 'dual'); updateCanvas(); }
        function isChinese(char) { const code = char.charCodeAt(0); return (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF) || (code >= 0x3000 && code <= 0x303F) || (code >= 0xFF00 && code <= 0xFFEF) || (code >= 0x3040 && code <= 0x309F) || (code >= 0x30A0 && code <= 0x30FF) || (code >= 0xAC00 && code <= 0xD7AF); }
        function hasChinese(text) { for (let i = 0; i < text.length; i++) { if (isChinese(text[i])) return true; } return false; }
        function hasNonChinese(text) { for (let i = 0; i < text.length; i++) { if (!isChinese(text[i])) return true; } return false; }
        function checkCharCount() { const text = document.getElementById('textInput').value; const count = text.length; const counter = document.getElementById('charCounter'); const downloadBtn = document.getElementById('downloadBtn'); counter.textContent = `${count} / 22`; if (count > 22) { counter.className = 'char-counter error'; downloadBtn.disabled = true; } else { counter.className = 'char-counter'; downloadBtn.disabled = false; } }

        // --- 模板相關函數 (完整版) ---
        async function loadTemplates(){try{const response=await fetch("./templates.json");if(response.ok){const jsonTemplates=await response.json();if(Array.isArray(jsonTemplates)){defaultTemplatesFromFile=jsonTemplates}}}catch(error){console.log("讀取預設 templates.json 失敗:",error)}
        let userTemplates=[];const saved=localStorage.getItem("pngTemplates");if(saved){try{const parsed=JSON.parse(saved);if(Array.isArray(parsed)){userTemplates=parsed}}catch(error){console.error("解析 localStorage 模板失敗:",error)}}
        templates=[...defaultTemplatesFromFile,...userTemplates];if(templates.length===0){templates.push({name:"標準模板",fontSize:42.34,letterSpacing:15,paddingTop:10,paddingBottom:10,paddingLeft:20,paddingRight:20,fontMode:"single",singleFont:"'Noto Sans CJK TC', sans-serif",textColor:"#000000",rotate:false,desc:"預設標準模板"})}
        renderTemplates()}
        function saveTemplatesLocal(){const defaultTemplatesSet=new Set(defaultTemplatesFromFile.map(t=>JSON.stringify(t)));const userTemplatesToSave=templates.filter(t=>!defaultTemplatesSet.has(JSON.stringify(t)));localStorage.setItem("pngTemplates",JSON.stringify(userTemplatesToSave))}
        function renderTemplates(){const grid=document.getElementById("templateGrid");grid.innerHTML=`<div class="add-template-card" onclick="openTemplateModal()"><div style="font-size: 48px; color: #667eea;">+</div><div style="color: #667eea; margin-top: 10px;">新增模板</div></div>`;templates.forEach((template,index)=>{const card=document.createElement("div");card.className="template-card";if(template.name===currentTemplateName)card.classList.add("active");card.innerHTML=`<button class="edit-btn" onclick="editTemplate(${index}); event.stopPropagation();">✎</button><button class="delete-btn" onclick="deleteTemplate(${index}); event.stopPropagation();">×</button><div style="font-weight: bold; margin-bottom: 5px;">${template.name}</div><div style="font-size: 12px; color: #666;">${template.fontSize}px | 字距${template.letterSpacing}px<br>${template.fontMode==="dual"?"中英分離":"統一字體"}${template.rotate?"<br>旋轉180°":""}${template.desc?"<br>"+template.desc:""}</div>`;card.onclick=()=>applyTemplate(template);grid.appendChild(card)})}
        function openTemplateModal(){document.getElementById("templateModal").style.display="block";document.getElementById("editIndex").value="-1";document.getElementById("templateName").value="";document.getElementById("templateFontSize").value=document.getElementById("fontSize").value;document.getElementById("templateLetterSpacing").value=document.getElementById("letterSpacing").value;document.getElementById("templatePaddingTop").value=document.getElementById("paddingTop").value;document.getElementById("templatePaddingBottom").value=document.getElementById("paddingBottom").value;document.getElementById("templatePaddingLeft").value=document.getElementById("paddingLeft").value;document.getElementById("templatePaddingRight").value=document.getElementById("paddingRight").value;document.getElementById("templateFontMode").value=fontMode;document.getElementById("templateSingleFont").value=document.getElementById("fontFamily").value;document.getElementById("templateEnglishFont").value=document.getElementById("englishFont").value;document.getElementById("templateChineseFont").value=document.getElementById("chineseFont").value;document.getElementById("templateTextColor").value=document.getElementById("textColor").value;document.getElementById("templateRotate").checked=document.getElementById("rotate180").checked;document.getElementById("templateDesc").value=""}
        function closeModal(){document.getElementById("templateModal").style.display="none"}
        function saveTemplate(){const name=document.getElementById("templateName").value.trim();if(!name){alert("請輸入模板名稱");return}
        const template={name:name,fontSize:parseFloat(document.getElementById("templateFontSize").value),letterSpacing:parseInt(document.getElementById("templateLetterSpacing").value),paddingTop:parseInt(document.getElementById("templatePaddingTop").value),paddingBottom:parseInt(document.getElementById("templatePaddingBottom").value),paddingLeft:parseInt(document.getElementById("templatePaddingLeft").value),paddingRight:parseInt(document.getElementById("templatePaddingRight").value),fontMode:document.getElementById("templateFontMode").value,singleFont:document.getElementById("templateSingleFont").value,englishFont:document.getElementById("templateEnglishFont").value,chineseFont:document.getElementById("templateChineseFont").value,textColor:document.getElementById("templateTextColor").value,rotate:document.getElementById("templateRotate").checked,desc:document.getElementById("templateDesc").value.trim()};const editIndex=parseInt(document.getElementById("editIndex").value);if(editIndex>=0){templates[editIndex]=template}else{templates.push(template)}
        saveTemplatesLocal();renderTemplates();closeModal();alert("模板已儲存！")}
        function editTemplate(index){const template=templates[index];document.getElementById("templateModal").style.display="block";document.getElementById("editIndex").value=index;document.getElementById("templateName").value=template.name;document.getElementById("templateFontSize").value=template.fontSize;document.getElementById("templateLetterSpacing").value=template.letterSpacing;document.getElementById("templatePaddingTop").value=template.paddingTop||template.paddingY||10;document.getElementById("templatePaddingBottom").value=template.paddingBottom||template.paddingY||10;document.getElementById("templatePaddingLeft").value=template.paddingLeft||template.paddingX||20;document.getElementById("templatePaddingRight").value=template.paddingRight||template.paddingX||20;document.getElementById("templateFontMode").value=template.fontMode||"single";document.getElementById("templateSingleFont").value=template.singleFont||"'Noto Sans CJK TC', sans-serif";document.getElementById("templateEnglishFont").value=template.englishFont||"'Avenir Next Condensed', sans-serif";document.getElementById("templateChineseFont").value=template.chineseFont||"'Noto Sans CJK TC', sans-serif";document.getElementById("templateTextColor").value=template.textColor||"#000000";document.getElementById("templateRotate").checked=template.rotate||false;document.getElementById("templateDesc").value=template.desc||""}
        function deleteTemplate(index){if(confirm("確定要刪除這個模板嗎？")){templates.splice(index,1);saveTemplatesLocal();renderTemplates()}}
        function applyTemplate(template){if(currentTemplateName===template.name){currentTemplateName=null;document.getElementById("currentTemplate").textContent="無";renderTemplates();alert("已取消選擇模板");return}
        document.getElementById("fontSize").value=template.fontSize;document.getElementById("letterSpacing").value=template.letterSpacing;document.getElementById("paddingTop").value=template.paddingTop||template.paddingY||10;document.getElementById("paddingBottom").value=template.paddingBottom||template.paddingY||10;document.getElementById("paddingLeft").value=template.paddingLeft||template.paddingX||20;document.getElementById("paddingRight").value=template.paddingRight||template.paddingX||20;document.getElementById("textColor").value=template.textColor||"#000000";document.getElementById("rotate180").checked=template.rotate||false;document.getElementById("chineseYOffset").value=template.chineseYOffset||0;document.getElementById("englishYOffset").value=template.englishYOffset||0;const fontModeToApply=template.fontMode||"single";const modeButtonIndex=fontModeToApply==="dual"?1:0;document.querySelectorAll(".font-mode-btn")[modeButtonIndex].click();if(fontModeToApply==="dual"){document.getElementById("englishFont").value=template.englishFont||"'Avenir Next Condensed', sans-serif";document.getElementById("chineseFont").value=template.chineseFont||"'Noto Sans CJK TC', sans-serif"}else{document.getElementById("fontFamily").value=template.singleFont||"'Noto Sans CJK TC', sans-serif"}
        currentTemplateName=template.name;document.getElementById("currentTemplate").textContent=template.name;renderTemplates();updateCanvas();alert(`已套用模板：${template.name}`)}
        function exportTemplates(){if(templates.length===0){alert("沒有可匯出的模板");return}
        const dataStr=JSON.stringify(templates,null,2);const dataBlob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(dataBlob);const link=document.createElement("a");link.href=url;link.download=`templates-${Date.now()}.json`;link.click();URL.revokeObjectURL(url)}
        function importTemplates(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=function(e){try{const imported=JSON.parse(e.target.result);if(Array.isArray(imported)){templates=templates.concat(imported);saveTemplatesLocal();renderTemplates();alert("模板匯入成功！")}else{alert("匯入失敗：檔案格式無效")}}catch(error){alert("匯入失敗：檔案格式錯誤")}};reader.readAsText(file);event.target.value=""}
        
        // --- Canvas 核心繪圖函數 ---
        async function updateCanvas() {
            await document.fonts.ready;

            const textCanvas = document.getElementById('textCanvas');
            const guideCanvas = document.getElementById('guideCanvas');
            const wrapper = document.getElementById('canvasWrapper');
            const ctx = textCanvas.getContext('2d');
            const guideCtx = guideCanvas.getContext('2d');

            const text = document.getElementById('textInput').value || 'Hello, World';
            const fontSize = parseFloat(document.getElementById('fontSize').value);
            const letterSpacing = parseInt(document.getElementById('letterSpacing').value);
            const textColor = document.getElementById('textColor').value;
            const paddingTop = parseInt(document.getElementById('paddingTop').value) || 0;
            const paddingBottom = parseInt(document.getElementById('paddingBottom').value) || 0;
            const paddingLeft = parseInt(document.getElementById('paddingLeft').value) || 0;
            const paddingRight = parseInt(document.getElementById('paddingRight').value) || 0;
            const rotate = document.getElementById('rotate180').checked;
            const singleFont = document.getElementById('fontFamily').value;
            const englishFont = document.getElementById('englishFont').value;
            const chineseFont = document.getElementById('chineseFont').value;
            const chineseYOffset = parseFloat(document.getElementById('chineseYOffset').value) || 0;
            const englishYOffset = parseFloat(document.getElementById('englishYOffset').value) || 0;
            const showGuides = document.getElementById('showAlignmentGuides').checked;

            const tempCtx = document.createElement('canvas').getContext('2d');
            let coreWidth = 0;
            let maxRawAscent = 0;
            let maxRawDescent = 0;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const isCharChinese = isChinese(char);
                const font = fontMode === 'dual' ? (isCharChinese ? chineseFont : englishFont) : singleFont;
                tempCtx.font = `${fontSize}px ${font}`;
                const metrics = tempCtx.measureText(char);
                coreWidth += metrics.width;
                maxRawAscent = Math.max(maxRawAscent, metrics.actualBoundingBoxAscent || fontSize * 0.8);
                maxRawDescent = Math.max(maxRawDescent, metrics.actualBoundingBoxDescent || fontSize * 0.2);
            }
            if (text.length > 1) {
                coreWidth += letterSpacing * (text.length - 1);
            }
            const coreHeight = maxRawAscent + maxRawDescent;

            const canvasWidth = coreWidth + paddingLeft + paddingRight;
            const canvasHeight = coreHeight + paddingTop + paddingBottom;
            
            [textCanvas, guideCanvas].forEach(c => {
                c.width = canvasWidth;
                c.height = canvasHeight;
            });
            wrapper.style.width = `${canvasWidth}px`;
            wrapper.style.height = `${canvasHeight}px`;

            ctx.textBaseline = 'alphabetic';
            guideCtx.textBaseline = 'alphabetic';

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            if (rotate) {
                ctx.save();
                ctx.translate(canvasWidth / 2, canvasHeight / 2);
                ctx.rotate(Math.PI);
                ctx.translate(-canvasWidth / 2, -canvasHeight / 2);
            }

            ctx.fillStyle = textColor;
            let x = paddingLeft;
            const stable_alphabetic_baseline = paddingTop + maxRawAscent;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const isCharChinese = isChinese(char);
                const yOffset = isCharChinese ? chineseYOffset : englishYOffset;
                const font = fontMode === 'dual' ? (isCharChinese ? chineseFont : englishFont) : singleFont;
                ctx.font = `${fontSize}px ${font}`;
                ctx.fillText(char, x, stable_alphabetic_baseline + yOffset);
                x += ctx.measureText(char).width + letterSpacing;
            }
            if (rotate) ctx.restore();

            guideCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            if (showGuides) {
                guideCtx.lineWidth = 1;
                const drawLine = (y, color) => {
                    guideCtx.strokeStyle = color;
                    guideCtx.beginPath();
                    guideCtx.moveTo(0, y);
                    guideCtx.lineTo(canvasWidth, y);
                    guideCtx.stroke();
                };

                if (hasNonChinese(text)) {
                    const fontForEnglish = fontMode === 'dual' ? englishFont : singleFont;
                    guideCtx.font = `${fontSize}px ${fontForEnglish}`;
                    const metrics = guideCtx.measureText('gA');
                    const ascent = metrics.actualBoundingBoxAscent || fontSize * 0.8;
                    const descent = metrics.actualBoundingBoxDescent || fontSize * 0.2;
                    
                    const baseline = stable_alphabetic_baseline + englishYOffset;
                    const top = baseline - ascent;
                    const bottom = baseline + descent;
                    const middle = top + (ascent + descent) / 2;

                    [top, middle, bottom].forEach(y => drawLine(y, 'rgba(255, 0, 0, 0.5)'));
                }
                
                if (hasChinese(text)) {
                    const fontForChinese = fontMode === 'dual' ? chineseFont : singleFont;
                    guideCtx.font = `${fontSize}px ${fontForChinese}`;
                    const metrics = guideCtx.measureText('中');
                    const ascent = metrics.actualBoundingBoxAscent || fontSize * 0.8;
                    const descent = metrics.actualBoundingBoxDescent || fontSize * 0.2;

                    const baseline = stable_alphabetic_baseline + chineseYOffset;
                    const top = baseline - ascent;
                    const bottom = baseline + descent;
                    const middle = top + (ascent + descent) / 2;

                    [top, middle, bottom].forEach(y => drawLine(y, 'rgba(0, 0, 255, 0.5)'));
                }
            }
            
            document.getElementById('sizeInfo').textContent = `尺寸: ${Math.round(canvasWidth)} × ${Math.round(canvasHeight)} px | 模式: ${fontMode === 'dual' ? '中英分離' : '統一字體'} ${rotate ? '| 旋轉180°' : ''}`;
        }

        // --- 下載函數 ---
        async function downloadPNG() {
            const finalCanvas = document.createElement('canvas');
            const finalCtx = finalCanvas.getContext('2d');
            const textCanvas = document.getElementById('textCanvas');
            
            finalCanvas.width = textCanvas.width;
            finalCanvas.height = textCanvas.height;
            finalCtx.drawImage(textCanvas, 0, 0);

            const shippingNumber = document.getElementById('shippingNumberInput').value.trim();
            const text = document.getElementById('textInput').value;
            const date = new Date();
            const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
            const timeStr = `${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}${String(date.getSeconds()).padStart(2, '0')}`;
            const timestamp = `${dateStr}${timeStr}`;
            const safeText = text.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_').substring(0, 15);
            
            const filenamePrefix = shippingNumber ? `${shippingNumber}_` : '';
            const filename = `${filenamePrefix}${safeText}_${timestamp}.png`;
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = finalCanvas.toDataURL("image/png");
            link.click();
        }
    </script>
</body>
</html>
