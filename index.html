<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—è½‰PNGè½‰æ›å™¨</title>
    <style>
        /* è¼‰å…¥æ‚¨æŒ‡å®šçš„ .woff2 æ ¼å¼å­—é«” */
        @font-face {
          font-family: 'Rage Italic';
          src: url('./fonts/RageItalic.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Avenir Next Condensed';
          src: url('./fonts/AvenirNextCondensed.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Taipei Sans TC Beta';
          src: url('./fonts/TaipeiSansTCBeta.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Noto Sans CJK TC';
          src: url('./fonts/NotoSansCJKtc.woff2') format('woff2');
        }
        @font-face {
          font-family: 'å¾®è»Ÿæ­£é»‘é«”';
          src: url('./fonts/MicrosoftJhengHei.woff2') format('woff2');
        }

        /* é€šç”¨æ¨£å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans CJK TC', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; padding: 20px; background: #f8f9ff; border-radius: 10px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-top: 5px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .info-box { padding: 10px; background: #fff8e1; border-radius: 8px; font-size: 13px; color: #f57c00; margin-top: 15px; }
        .char-counter { text-align: right; font-size: 14px; margin-top: 5px; color: #666; }
        .char-counter.error { color: #ff5252; font-weight: bold; }
        .checkbox-group { display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-top: 10px; }
        input[type="checkbox"] { width: auto; margin-right: 8px; }
        
        /* é è¦½å€ Grid ä½ˆå±€ */
        .preview-grid {
            display: grid;
            grid-template-columns: 40px 1fr 40px;
            grid-template-rows: 40px auto 40px;
            gap: 10px;
            align-items: center;
            justify-items: center;
            margin: 20px auto 50px auto;
            max-width: 100%;
        }

        /* é‚Šè·èª¿æ•´æŒ‰éˆ•æ¨£å¼ */
        .margin-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .margin-controls.horizontal {
            flex-direction: row;
        }
        .margin-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
            color: #666;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            user-select: none;
            transition: all 0.2s;
        }
        .margin-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .margin-label {
            font-size: 10px;
            color: #999;
            text-align: center;
        }

        #canvasWrapper {
            position: relative;
            margin: 0;
            max-width: 100%;
            display: inline-block;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            /* ========== START: æ”¾å¤§ 30% ========== */
            transform: scale(1.3);
            transform-origin: center;
            /* ========== END: æ”¾å¤§ 30% ========== */
            grid-column: 2;
            grid-row: 2;
        }
        #textCanvas, #guideCanvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        #textCanvas { z-index: 1; }
        #guideCanvas { z-index: 2; pointer-events: none; }
        
        .font-mode-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .font-mode-btn { flex: 1; padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .font-mode-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .font-settings { display: none; }
        .font-settings.active { display: block; }
        
        /* æ¨¡æ¿æ‹–æ›³ç›¸é—œæ¨£å¼ */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 15px; }
        .template-card { padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer; text-align: center; transition: all 0.3s; position: relative; min-height: 140px; }
        .template-card:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .template-card.active { border-color: #667eea; background: #f0f2ff; }
        .template-card.dragging { opacity: 0.4; border: 2px dashed #667eea; }
        
        .add-template-card { padding: 15px; background: #fff; border: 2px dashed #667eea; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .add-template-card:hover { background: #f0f2ff; border-color: #764ba2; transform: translateY(-2px); }
        .delete-btn, .edit-btn { position: absolute; top: 5px; width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; display: none; color: white; font-size: 12px; }
        .delete-btn { right: 5px; background: #ff5252; }
        .edit-btn { right: 35px; background: #667eea; }
        .template-card:hover .delete-btn, .template-card:hover .edit-btn { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 3% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; transition: opacity 0.3s; }
        #loadingBox { width: 90%; max-width: 400px; text-align: center; }
        #loadingMessage { font-size: 1.2em; margin-bottom: 15px; }
        #progressBarContainer { width: 100%; background: #444; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        #progressBar { width: 0%; height: 10px; background: #667eea; transition: width 0.2s ease-out; }
        #fontStatus { font-size: 0.9em; height: 20px; color: #ccc; }

        .stepper { display: flex; align-items: center; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-top: 5px; }
        .stepper:focus-within { border-color: #667eea; }
        .stepper input { width: 100%; border: none; text-align: center; margin: 0; padding: 8px 0; -moz-appearance: textfield; }
        .stepper input::-webkit-outer-spin-button, .stepper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stepper-btn { background: #f0f2ff; border: none; cursor: pointer; font-size: 18px; color: #667eea; font-weight: bold; transition: background 0.2s; width: 34px; height: 38px; flex-shrink: 0; user-select: none; }
        .stepper-btn:hover { background: #dfe3ff; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div id="loadingBox">
            <div id="loadingMessage">æ­£åœ¨è¼‰å…¥å­—é«”...</div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
            <div id="fontStatus">(0/5)</div>
        </div>
    </div>

    <div class="container">
        <div class="header"><h1>âœ¨ æ–‡å­—è½‰PNGè½‰æ›å™¨</h1><p>è‡ªå®šç¾©æ¨¡æ¿ â€¢ 22å­—å…ƒé™åˆ¶ â€¢ é€æ˜èƒŒæ™¯ â€¢ ä¸­è‹±åˆ†é›¢å­—é«”</p></div>
        <div class="content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title">ğŸ¨ è‡ªå®šç¾©æ¨¡æ¿</div>
                    <div>
                        <button class="btn btn-secondary" onclick="exportTemplates()">ğŸ“¤ åŒ¯å‡º</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="margin: 0 10px;">ğŸ“¥ åŒ¯å…¥</button>
                        <button class="btn btn-secondary" onclick="resetToDefaultTemplates()" style="border-color: #ff5252; color: #ff5252;">ğŸ§¹ é‡ç½®é è¨­</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTemplates(event)">
                        <button class="btn btn-primary" onclick="openTemplateModal()" style="margin-left: 10px;">+ æ–°å¢æ¨¡æ¿</button>
                    </div>
                </div>
                <div class="info-box" style="margin-bottom: 10px;">ğŸ’¡ <strong>æç¤ºï¼š</strong>å¯æ‹–æ›³å¡ç‰‡é‡æ–°æ’åºã€‚é»æ“Šæ¨¡æ¿å¥—ç”¨æ‰€æœ‰è¨­å®šã€‚ã€Œé‡ç½®é è¨­ã€å¯æ¸…é™¤æœ¬åœ°ç´€éŒ„ä¸¦é‡æ–°è®€å–é ç«¯æ¨¡æ¿ã€‚</div>
                <div class="template-grid" id="templateGrid">
                    <div class="add-template-card" onclick="openTemplateModal()"><div style="font-size: 48px; color: #667eea;">+</div><div style="color: #667eea; margin-top: 10px;">æ–°å¢æ¨¡æ¿</div></div>
                </div>
                <div class="info-box">ç•¶å‰ä½¿ç”¨æ¨¡æ¿ï¼š<span id="currentTemplate">ç„¡</span></div>
            </div>

            <div class="section">
                <div style="margin-bottom: 20px;">
                    <label for="shippingNumberInput" style="display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #333;">ğŸ“¦ å¯„ä»¶ç·¨è™Ÿ (æª”åå‰ç¶´)</label>
                    <input type="text" id="shippingNumberInput" placeholder="é¸å¡«ï¼Œå°‡ä½œç‚ºä¸‹è¼‰æª”åçš„é–‹é ­">
                </div>
                <div class="section-title">è¼¸å…¥æ–‡å­—ï¼ˆæœ€å¤š22å­—å…ƒï¼‰</div>
                <textarea id="textInput" placeholder="è«‹è¼¸å…¥è¦è½‰æ›çš„æ–‡å­—..." maxlength="50" style="height: 100px;">My Cute Jigglypuff</textarea>
                <div class="char-counter" id="charCounter">14 / 22</div>
            </div>

            <div class="section"><div class="section-title">å­—é«”è¨­å®š</div><div class="font-mode-toggle"><button class="font-mode-btn active" onclick="switchFontMode('single', event)">çµ±ä¸€å­—é«”</button><button class="font-mode-btn" onclick="switchFontMode('dual', event)">ä¸­è‹±åˆ†é›¢</button></div>
                <div id="singleFontSettings" class="font-settings active"><div><label>å­—é«”</label><select id="fontFamily"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option><option value="Arial, sans-serif">Arial (ç³»çµ±)</option></select></div></div>
                <div id="dualFontSettings" class="font-settings"><div class="grid-2"><div><label>è‹±æ–‡å­—é«”</label><select id="englishFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option><option value="Arial, sans-serif">Arial (ç³»çµ±)</option></select></div><div><label>ä¸­æ–‡å­—é«”</label><select id="chineseFont"><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option></select></div></div></div>
            </div>
            <div class="section"><div class="section-title">è¼¸å‡ºè¨­å®š</div>
                <div class="grid-2" style="margin-bottom: 15px;">
                    <div><label>å­—ç´š (px)</label><input type="number" id="fontSize" value="42.34" min="8" max="200" step="0.01"></div>
                    <div><label>å­—è· (px)</label><input type="number" id="letterSpacing" value="15" min="-10" max="500"></div>
                    <div><label>æ–‡å­—é¡è‰²</label><input type="color" id="textColor" value="#000000" style="padding: 5px; height: 42px;"></div>
                </div>
                <div class="grid-2" style="margin-bottom: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <div><label>ä¸­æ–‡ Y è»¸åç§» (px)</label><input type="number" id="chineseYOffset" value="0" step="0.5"></div>
                    <div><label>è‹±æ–‡ Y è»¸åç§» (px)</label><input type="number" id="englishYOffset" value="0" step="0.5"></div>
                </div>
                <div class="grid-4">
                    <div><label>ä¸Šé‚Šè· (Top)</label><input type="number" id="paddingTop" value="10" max="200"></div>
                    <div><label>ä¸‹é‚Šè· (Bottom)</label><input type="number" id="paddingBottom" value="10" max="200"></div>
                    <div><label>å·¦é‚Šè· (Left)</label><input type="number" id="paddingLeft" value="10" max="200"></div>
                    <div><label>å³é‚Šè· (Right)</label><input type="number" id="paddingRight" value="10" max="200"></div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rotate180"><label for="rotate180">æ—‹è½‰180åº¦</label>
                    <input type="checkbox" id="showAlignmentGuides" style="margin-left: 20px;" checked><label for="showAlignmentGuides">é¡¯ç¤ºå°é½Šè¼”åŠ©ç·š</label>
                </div>
                <div class="info-box">ğŸ“Œ <strong>æç¤ºï¼š</strong>æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹æ–¹é è¦½å€å‘¨åœçš„æŒ‰éˆ•å¿«é€Ÿèª¿æ•´é‚Šè·ã€‚å‹¾é¸æ—‹è½‰æ™‚ï¼ŒæŒ‰éˆ•æ–¹å‘æœƒæ™ºæ…§èª¿æ•´ã€‚</div>
            </div>
            <div class="section" style="text-align: center;"> <div class="section-title" style="text-align: left;">é è¦½èˆ‡ä¸‹è¼‰</div>
                
                <div class="preview-grid">
                    <div class="margin-controls horizontal" style="grid-column: 2; grid-row: 1;">
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Top', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Top', -1)" ontouchend="stopAdjusting()">-</button>
                        <span class="margin-label">ä¸Š</span>
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Top', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Top', 1)" ontouchend="stopAdjusting()">+</button>
                    </div>

                    <div class="margin-controls" style="grid-column: 1; grid-row: 2;">
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Left', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Left', 1)" ontouchend="stopAdjusting()">+</button>
                        <span class="margin-label">å·¦</span>
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Left', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Left', -1)" ontouchend="stopAdjusting()">-</button>
                    </div>

                    <div id="canvasWrapper">
                        <canvas id="textCanvas"></canvas>
                        <canvas id="guideCanvas"></canvas>
                    </div>

                    <div class="margin-controls" style="grid-column: 3; grid-row: 2;">
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Right', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Right', 1)" ontouchend="stopAdjusting()">+</button>
                        <span class="margin-label">å³</span>
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Right', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Right', -1)" ontouchend="stopAdjusting()">-</button>
                    </div>

                    <div class="margin-controls horizontal" style="grid-column: 2; grid-row: 3;">
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Bottom', -1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Bottom', -1)" ontouchend="stopAdjusting()">-</button>
                        <span class="margin-label">ä¸‹</span>
                        <button class="margin-btn" onmousedown="smartAdjustPadding('Bottom', 1)" onmouseup="stopAdjusting()" onmouseleave="stopAdjusting()" ontouchstart="smartAdjustPadding('Bottom', 1)" ontouchend="stopAdjusting()">+</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;" id="sizeInfo">å°ºå¯¸è³‡è¨Š</div>

                <div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" id="downloadBtn" onclick="downloadPNG()">ä¸‹è¼‰ PNG</button></div>
            </div>
        </div>
    </div>
    <div id="templateModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal()">&times;</span><h2 style="margin-bottom: 20px;">ğŸ“ æ¨¡æ¿è¨­å®š</h2><input type="hidden" id="editIndex" value="-1"><div style="margin-bottom: 15px;"><label>æ¨¡æ¿åç¨± *</label><input type="text" id="templateName" placeholder="ä¾‹å¦‚ï¼šç¶²ç«™æ¨™é¡Œ"></div><div style="margin-bottom: 15px;"><label>å­—é«”æ¨¡å¼</label><select id="templateFontMode"><option value="single">çµ±ä¸€å­—é«”</option><option value="dual">ä¸­è‹±åˆ†é›¢</option></select></div>
            <div style="margin-bottom: 15px;"><label>çµ±ä¸€å­—é«”ï¼ˆçµ±ä¸€æ¨¡å¼ç”¨ï¼‰</label><select id="templateSingleFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option><option value="Arial, sans-serif">Arial (ç³»çµ±)</option></select></div>
            <div class="grid-2" style="margin-bottom: 15px;"><div><label>è‹±æ–‡å­—é«”ï¼ˆåˆ†é›¢æ¨¡å¼ç”¨ï¼‰</label><select id="templateEnglishFont"><option value="'Rage Italic', cursive">Rage Italic</option><option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option><option value="Arial, sans-serif">Arial (ç³»çµ±)</option></select></div><div><label>ä¸­æ–‡å­—é«”</label><select id="templateChineseFont"><option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option><option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option><option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option></select></div></div>
            <div class="grid-2" style="margin-bottom: 15px;">
                <div><label>å­—ç´š (px)</label><input type="number" id="templateFontSize" value="42.34" step="0.01"></div>
                <div><label>å­—è· (px)</label><input type="number" id="templateLetterSpacing" value="15"></div>
                <div><label>æ–‡å­—é¡è‰²</label><input type="color" id="templateTextColor" value="#000000"></div>
            </div>
             <div class="grid-4" style="margin-bottom: 15px;">
                <div><label>ä¸Šé‚Šè·</label><input type="number" id="templatePaddingTop" value="10"></div>
                <div><label>ä¸‹é‚Šè·</label><input type="number" id="templatePaddingBottom" value="10"></div>
                <div><label>å·¦é‚Šè·</label><input type="number" id="templatePaddingLeft" value="20"></div>
                <div><label>å³é‚Šè·</label><input type="number" id="templatePaddingRight" value="20"></div>
            </div>
            <div style="margin-bottom: 15px;"><input type="checkbox" id="templateRotate"><label for="templateRotate">æ—‹è½‰180åº¦</label></div><div style="margin-bottom: 15px;"><label>æè¿°ï¼ˆé¸å¡«ï¼‰</label><input type="text" id="templateDesc" placeholder="ä¾‹å¦‚ï¼šé©ç”¨æ–¼ä¸»æ¨™é¡Œ"></div><div style="margin-top: 20px;"><button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button><button class="btn btn-secondary" onclick="closeModal()" style="margin-left: 10px;">å–æ¶ˆ</button></div></div></div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let templates = [];
        let defaultTemplatesFromFile = [];
        let fontMode = 'single';
        let currentTemplateName = null;
        let adjustTimeout = null;
        let adjustInterval = null;
        
        // --- åˆå§‹åŒ– ---
        window.onload = async function() {
            const fontsLoaded = await loadFontsWithProgress();
            if (fontsLoaded) {
                await loadTemplates();
                initApp();
            }
        };

        function initApp() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.opacity = 0;
            setTimeout(() => loadingOverlay.style.display = 'none', 300);
            
            checkCharCount();
            
            const inputs = ['textInput', 'fontSize', 'letterSpacing', 'textColor', 'paddingTop', 'paddingBottom', 'paddingLeft', 'paddingRight', 'fontFamily', 'englishFont', 'chineseFont', 'rotate180', 'chineseYOffset', 'englishYOffset', 'showAlignmentGuides'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                const event = (element.type === 'checkbox' || element.tagName === 'SELECT') ? 'change' : 'input';
                element.addEventListener(event, () => {
                    if (id === 'textInput') checkCharCount();
                    updateCanvas();
                });
            });

            updateCanvas();
        }

        // --- å­—é«”è¼‰å…¥ ---
        async function loadFontsWithProgress() {
            const fontsToLoad = [
                { name: 'Rage Italic', url: './fonts/RageItalic.woff2' },
                { name: 'Avenir Next Condensed', url: './fonts/AvenirNextCondensed.woff2' },
                { name: 'Taipei Sans TC Beta', url: './fonts/TaipeiSansTCBeta.woff2' },
                { name: 'Noto Sans CJK TC', url: './fonts/NotoSansCJKtc.woff2' },
                { name: 'å¾®è»Ÿæ­£é»‘é«”', url: './fonts/MicrosoftJhengHei.woff2' }
            ];
            const loadingMessage = document.getElementById('loadingMessage');
            const progressBar = document.getElementById('progressBar');
            const fontStatus = document.getElementById('fontStatus');
            let loadedCount = 0;
            const fontPromises = fontsToLoad.map(fontData => {
                const fontFace = new FontFace(fontData.name, `url(${fontData.url})`);
                return fontFace.load().then(loadedFont => {
                    document.fonts.add(loadedFont);
                    loadedCount++;
                    progressBar.style.width = `${(loadedCount / fontsToLoad.length) * 100}%`;
                    fontStatus.textContent = `(${loadedCount}/${fontsToLoad.length}) ${fontData.name}`;
                }).catch(error => { throw new Error(`å­—é«” "${fontData.name}" è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆï¼š${fontData.url}`); });
            });
            try {
                await Promise.all(fontPromises);
                loadingMessage.textContent = "å­—é«”è¼‰å…¥å®Œæˆï¼";
                return true;
            } catch (error) {
                loadingMessage.style.color = '#ff5252';
                loadingMessage.textContent = 'éŒ¯èª¤';
                fontStatus.textContent = error.message;
                return false;
            }
        }
        
        // --- è¼”åŠ©å‡½æ•¸ ---
        function adjustPadding(inputId, amount) { 
            const input = document.getElementById(inputId); 
            let value = parseInt(input.value, 10) || 0; 
            value += amount; 
            input.value = value; 
            input.dispatchEvent(new Event('input')); 
        }

        function smartAdjustPadding(visualSide, amount) {
            const isRotated = document.getElementById('rotate180').checked;
            let logicalSide = visualSide;

            if (isRotated) {
                if (visualSide === 'Top') logicalSide = 'Bottom';
                else if (visualSide === 'Bottom') logicalSide = 'Top';
                else if (visualSide === 'Left') logicalSide = 'Right';
                else if (visualSide === 'Right') logicalSide = 'Left';
            }

            const inputId = 'padding' + logicalSide;
            startAdjusting(inputId, amount);
        }

        function startAdjusting(inputId, amount) { adjustPadding(inputId, amount); adjustTimeout = setTimeout(() => { adjustInterval = setInterval(() => { adjustPadding(inputId, amount); }, 100); }, 400); }
        function stopAdjusting() { clearTimeout(adjustTimeout); clearInterval(adjustInterval); }
        function switchFontMode(mode, event) { fontMode = mode; document.querySelectorAll('.font-mode-btn').forEach(btn => btn.classList.remove('active')); if (event) event.target.classList.add('active'); document.getElementById('singleFontSettings').classList.toggle('active', mode === 'single'); document.getElementById('dualFontSettings').classList.toggle('active', mode === 'dual'); updateCanvas(); }
        function isChinese(char) { const code = char.charCodeAt(0); return (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF) || (code >= 0x3000 && code <= 0x303F) || (code >= 0xFF00 && code <= 0xFFEF) || (code >= 0x3040 && code <= 0x309F) || (code >= 0x30A0 && code <= 0x30FF) || (code >= 0xAC00 && code <= 0xD7AF); }
        function hasChinese(text) { for (let i = 0; i < text.length; i++) { if (isChinese(text[i])) return true; } return false; }
        function hasNonChinese(text) { for (let i = 0; i < text.length; i++) { if (!isChinese(text[i])) return true; } return false; }
        function checkCharCount() { const text = document.getElementById('textInput').value; const count = text.length; const counter = document.getElementById('charCounter'); const downloadBtn = document.getElementById('downloadBtn'); counter.textContent = `${count} / 22`; if (count > 22) { counter.className = 'char-counter error'; downloadBtn.disabled = true; } else { counter.className = 'char-counter'; downloadBtn.disabled = false; } }

        // --- æ¨¡æ¿ç›¸é—œå‡½æ•¸ ---
        async function loadTemplates(){
            // å„ªå…ˆè®€å–æœ¬åœ°å„²å­˜
            const savedFullList = localStorage.getItem("pngTemplates_full");
            if (savedFullList) {
                try {
                    const parsed = JSON.parse(savedFullList);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        templates = parsed;
                         try{const response=await fetch("./templates.json");if(response.ok){const jsonTemplates=await response.json();if(Array.isArray(jsonTemplates)){defaultTemplatesFromFile=jsonTemplates}}}catch(e){}
                        renderTemplates();
                        return;
                    }
                } catch(e) { console.error("è§£æå®Œæ•´åˆ—è¡¨å¤±æ•—", e); }
            }

            // æœ¬åœ°æ²’æœ‰ï¼Œè®€å–é ç«¯ JSON
            try{
                const response=await fetch("./templates.json");
                if(response.ok){
                    const jsonTemplates=await response.json();
                    if(Array.isArray(jsonTemplates)){
                        defaultTemplatesFromFile=jsonTemplates;
                    }
                }
            }catch(error){
                console.log("è®€å–é è¨­ templates.json å¤±æ•—:",error)
            }

            // ç›¸å®¹èˆŠç‰ˆ localStorage
            let userTemplates=[];
            const saved=localStorage.getItem("pngTemplates");
            if(saved){try{const parsed=JSON.parse(saved);if(Array.isArray(parsed)){userTemplates=parsed}}catch(error){console.error("è§£æ localStorage æ¨¡æ¿å¤±æ•—:",error)}}
            
            templates=[...defaultTemplatesFromFile,...userTemplates];
            if(templates.length===0){templates.push({name:"æ¨™æº–æ¨¡æ¿",fontSize:42.34,letterSpacing:15,paddingTop:10,paddingBottom:10,paddingLeft:20,paddingRight:20,fontMode:"single",singleFont:"'Noto Sans CJK TC', sans-serif",textColor:"#000000",rotate:false,desc:"é è¨­æ¨™æº–æ¨¡æ¿"})}
            renderTemplates();
        }

        // [æ–°å¢åŠŸèƒ½] é‡ç½®ç‚ºé è¨­æ¨¡æ¿
        async function resetToDefaultTemplates() {
            if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æœ¬åœ°æ¨¡æ¿å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. æ¸…é™¤æ‚¨åœ¨ç€è¦½å™¨ä¸­æ–°å¢æˆ–æ’åºéçš„æ‰€æœ‰æ¨¡æ¿ã€‚\n2. é‡æ–°è®€å–åŸå§‹è¨­å®šæª” (templates.json)ã€‚\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                localStorage.removeItem("pngTemplates");
                localStorage.removeItem("pngTemplates_full");
                
                // é‡æ–°å‘¼å« loadTemplatesï¼Œå®ƒæœƒå» fetch æœ€æ–°çš„ json
                await loadTemplates();
                currentTemplateName = null;
                document.getElementById("currentTemplate").textContent = "ç„¡";
                alert("å·²é‡ç½®æ‰€æœ‰æ¨¡æ¿ç‚ºé è¨­å€¼ï¼");
            }
        }

        function saveTemplatesLocal(){
            localStorage.setItem("pngTemplates_full", JSON.stringify(templates));
            const defaultTemplatesSet=new Set(defaultTemplatesFromFile.map(t=>JSON.stringify(t)));
            const userTemplatesToSave=templates.filter(t=>!defaultTemplatesSet.has(JSON.stringify(t)));
            localStorage.setItem("pngTemplates",JSON.stringify(userTemplatesToSave));
        }

        // æ‹–æ›³æ’åºç›¸é—œ
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) { this.classList.add('over'); }
        function handleDragLeave(e) { this.classList.remove('over'); }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const sourceIndex = parseInt(dragSrcEl.getAttribute('data-index'));
            const targetIndex = parseInt(this.getAttribute('data-index'));

            if (dragSrcEl !== this) {
                const movedItem = templates[sourceIndex];
                templates.splice(sourceIndex, 1);
                templates.splice(targetIndex, 0, movedItem);
                saveTemplatesLocal();
                renderTemplates();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.template-card').forEach(item => item.classList.remove('over'));
        }

        function renderTemplates(){
            const grid=document.getElementById("templateGrid");
            grid.innerHTML=`<div class="add-template-card" onclick="openTemplateModal()"><div style="font-size: 48px; color: #667eea;">+</div><div style="color: #667eea; margin-top: 10px;">æ–°å¢æ¨¡æ¿</div></div>`;
            templates.forEach((template,index)=>{
                const card=document.createElement("div");
                card.className="template-card";
                card.setAttribute('draggable', 'true');
                card.setAttribute('data-index', index);
                
                card.addEventListener('dragstart', handleDragStart, false);
                card.addEventListener('dragenter', handleDragEnter, false);
                card.addEventListener('dragover', handleDragOver, false);
                card.addEventListener('dragleave', handleDragLeave, false);
                card.addEventListener('drop', handleDrop, false);
                card.addEventListener('dragend', handleDragEnd, false);

                if(template.name===currentTemplateName)card.classList.add("active");
                card.innerHTML=`<button class="edit-btn" onclick="editTemplate(${index}); event.stopPropagation();">âœ</button><button class="delete-btn" onclick="deleteTemplate(${index}); event.stopPropagation();">Ã—</button><div style="font-weight: bold; margin-bottom: 5px;">${template.name}</div><div style="font-size: 12px; color: #666;">${template.fontSize}px | å­—è·${template.letterSpacing}px<br>${template.fontMode==="dual"?"ä¸­è‹±åˆ†é›¢":"çµ±ä¸€å­—é«”"}${template.rotate?"<br>æ—‹è½‰180Â°":""}${template.desc?"<br>"+template.desc:""}</div>`;
                card.onclick=()=>applyTemplate(template);
                grid.appendChild(card)
            })
        }

        function openTemplateModal(){document.getElementById("templateModal").style.display="block";document.getElementById("editIndex").value="-1";document.getElementById("templateName").value="";document.getElementById("templateFontSize").value=document.getElementById("fontSize").value;document.getElementById("templateLetterSpacing").value=document.getElementById("letterSpacing").value;document.getElementById("templatePaddingTop").value=document.getElementById("paddingTop").value;document.getElementById("templatePaddingBottom").value=document.getElementById("paddingBottom").value;document.getElementById("templatePaddingLeft").value=document.getElementById("paddingLeft").value;document.getElementById("templatePaddingRight").value=document.getElementById("paddingRight").value;document.getElementById("templateFontMode").value=fontMode;document.getElementById("templateSingleFont").value=document.getElementById("fontFamily").value;document.getElementById("templateEnglishFont").value=document.getElementById("englishFont").value;document.getElementById("templateChineseFont").value=document.getElementById("chineseFont").value;document.getElementById("templateTextColor").value=document.getElementById("textColor").value;document.getElementById("templateRotate").checked=document.getElementById("rotate180").checked;document.getElementById("templateDesc").value=""}
        function closeModal(){document.getElementById("templateModal").style.display="none"}
        function saveTemplate(){const name=document.getElementById("templateName").value.trim();if(!name){alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±");return}
        const template={name:name,fontSize:parseFloat(document.getElementById("templateFontSize").value),letterSpacing:parseInt(document.getElementById("templateLetterSpacing").value),paddingTop:parseInt(document.getElementById("templatePaddingTop").value),paddingBottom:parseInt(document.getElementById("templatePaddingBottom").value),paddingLeft:parseInt(document.getElementById("templatePaddingLeft").value),paddingRight:parseInt(document.getElementById("templatePaddingRight").value),fontMode:document.getElementById("templateFontMode").value,singleFont:document.getElementById("templateSingleFont").value,englishFont:document.getElementById("templateEnglishFont").value,chineseFont:document.getElementById("templateChineseFont").value,textColor:document.getElementById("templateTextColor").value,rotate:document.getElementById("templateRotate").checked,desc:document.getElementById("templateDesc").value.trim()};const editIndex=parseInt(document.getElementById("editIndex").value);if(editIndex>=0){templates[editIndex]=template}else{templates.push(template)}
        saveTemplatesLocal();renderTemplates();closeModal();alert("æ¨¡æ¿å·²å„²å­˜ï¼")}
        function editTemplate(index){const template=templates[index];document.getElementById("templateModal").style.display="block";document.getElementById("editIndex").value=index;document.getElementById("templateName").value=template.name;document.getElementById("templateFontSize").value=template.fontSize;document.getElementById("templateLetterSpacing").value=template.letterSpacing;document.getElementById("templatePaddingTop").value=template.paddingTop||template.paddingY||10;document.getElementById("templatePaddingBottom").value=template.paddingBottom||template.paddingY||10;document.getElementById("templatePaddingLeft").value=template.paddingLeft||template.paddingX||20;document.getElementById("templatePaddingRight").value=template.paddingRight||template.paddingX||20;document.getElementById("templateFontMode").value=template.fontMode||"single";document.getElementById("templateSingleFont").value=template.singleFont||"'Noto Sans CJK TC', sans-serif";document.getElementById("templateEnglishFont").value=template.englishFont||"'Avenir Next Condensed', sans-serif";document.getElementById("templateChineseFont").value=template.chineseFont||"'Noto Sans CJK TC', sans-serif";document.getElementById("templateTextColor").value=template.textColor||"#000000";document.getElementById("templateRotate").checked=template.rotate||false;document.getElementById("templateDesc").value=template.desc||""}
        function deleteTemplate(index){if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡æ¿å—ï¼Ÿ")){templates.splice(index,1);saveTemplatesLocal();renderTemplates()}}
        function applyTemplate(template){if(currentTemplateName===template.name){currentTemplateName=null;document.getElementById("currentTemplate").textContent="ç„¡";renderTemplates();alert("å·²å–æ¶ˆé¸æ“‡æ¨¡æ¿");return}
        document.getElementById("fontSize").value=template.fontSize;document.getElementById("letterSpacing").value=template.letterSpacing;document.getElementById("paddingTop").value=template.paddingTop||template.paddingY||10;document.getElementById("paddingBottom").value=template.paddingBottom||template.paddingY||10;document.getElementById("paddingLeft").value=template.paddingLeft||template.paddingX||20;document.getElementById("paddingRight").value=template.paddingRight||template.paddingX||20;document.getElementById("textColor").value=template.textColor||"#000000";document.getElementById("rotate180").checked=template.rotate||false;document.getElementById("chineseYOffset").value=template.chineseYOffset||0;document.getElementById("englishYOffset").value=template.englishYOffset||0;const fontModeToApply=template.fontMode||"single";const modeButtonIndex=fontModeToApply==="dual"?1:0;document.querySelectorAll(".font-mode-btn")[modeButtonIndex].click();if(fontModeToApply==="dual"){document.getElementById("englishFont").value=template.englishFont||"'Avenir Next Condensed', sans-serif";document.getElementById("chineseFont").value=template.chineseFont||"'Noto Sans CJK TC', sans-serif"}else{document.getElementById("fontFamily").value=template.singleFont||"'Noto Sans CJK TC', sans-serif"}
        currentTemplateName=template.name;document.getElementById("currentTemplate").textContent=template.name;renderTemplates();updateCanvas();alert(`å·²å¥—ç”¨æ¨¡æ¿ï¼š${template.name}`)}
        function exportTemplates(){if(templates.length===0){alert("æ²’æœ‰å¯åŒ¯å‡ºçš„æ¨¡æ¿");return}
        const dataStr=JSON.stringify(templates,null,2);const dataBlob=new Blob([dataStr],{type:"application/json"});const url=URL.createObjectURL(dataBlob);const link=document.createElement("a");link.href=url;link.download=`templates-${Date.now()}.json`;link.click();URL.revokeObjectURL(url)}
        function importTemplates(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=function(e){try{const imported=JSON.parse(e.target.result);if(Array.isArray(imported)){templates=templates.concat(imported);saveTemplatesLocal();renderTemplates();alert("æ¨¡æ¿åŒ¯å…¥æˆåŠŸï¼")}else{alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ç„¡æ•ˆ")}}catch(error){alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤")}};reader.readAsText(file);event.target.value=""}
        
        // --- Canvas æ ¸å¿ƒç¹ªåœ–å‡½æ•¸ ---
        async function updateCanvas() {
            await document.fonts.ready;

            const textCanvas = document.getElementById('textCanvas');
            const guideCanvas = document.getElementById('guideCanvas');
            const wrapper = document.getElementById('canvasWrapper');
            const ctx = textCanvas.getContext('2d');
            const guideCtx = guideCanvas.getContext('2d');

            const text = document.getElementById('textInput').value || 'Hello, World';
            const fontSize = parseFloat(document.getElementById('fontSize').value);
            const letterSpacing = parseInt(document.getElementById('letterSpacing').value);
            const textColor = document.getElementById('textColor').value;
            const paddingTop = parseInt(document.getElementById('paddingTop').value) || 0;
            const paddingBottom = parseInt(document.getElementById('paddingBottom').value) || 0;
            const paddingLeft = parseInt(document.getElementById('paddingLeft').value) || 0;
            const paddingRight = parseInt(document.getElementById('paddingRight').value) || 0;
            const rotate = document.getElementById('rotate180').checked;
            const singleFont = document.getElementById('fontFamily').value;
            const englishFont = document.getElementById('englishFont').value;
            const chineseFont = document.getElementById('chineseFont').value;
            const chineseYOffset = parseFloat(document.getElementById('chineseYOffset').value) || 0;
            const englishYOffset = parseFloat(document.getElementById('englishYOffset').value) || 0;
            const showGuides = document.getElementById('showAlignmentGuides').checked;

            const tempCtx = document.createElement('canvas').getContext('2d');
            let coreWidth = 0;
            let maxRawAscent = 0;
            let maxRawDescent = 0;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const isCharChinese = isChinese(char);
                const font = fontMode === 'dual' ? (isCharChinese ? chineseFont : englishFont) : singleFont;
                tempCtx.font = `${fontSize}px ${font}`;
                const metrics = tempCtx.measureText(char);
                coreWidth += metrics.width;
                maxRawAscent = Math.max(maxRawAscent, metrics.actualBoundingBoxAscent || fontSize * 0.8);
                maxRawDescent = Math.max(maxRawDescent, metrics.actualBoundingBoxDescent || fontSize * 0.2);
            }
            if (text.length > 1) {
                coreWidth += letterSpacing * (text.length - 1);
            }
            const coreHeight = maxRawAscent + maxRawDescent;

            const canvasWidth = coreWidth + paddingLeft + paddingRight;
            const canvasHeight = coreHeight + paddingTop + paddingBottom;
            
            [textCanvas, guideCanvas].forEach(c => {
                c.width = canvasWidth;
                c.height = canvasHeight;
            });
            wrapper.style.width = `${canvasWidth}px`;
            wrapper.style.height = `${canvasHeight}px`;

            ctx.textBaseline = 'alphabetic';
            guideCtx.textBaseline = 'alphabetic';

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            if (rotate) {
                ctx.save();
                ctx.translate(canvasWidth / 2, canvasHeight / 2);
                ctx.rotate(Math.PI);
                ctx.translate(-canvasWidth / 2, -canvasHeight / 2);
            }

            ctx.fillStyle = textColor;
            let x = paddingLeft;
            const stable_alphabetic_baseline = paddingTop + maxRawAscent;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const isCharChinese = isChinese(char);
                const yOffset = isCharChinese ? chineseYOffset : englishYOffset;
                const font = fontMode === 'dual' ? (isCharChinese ? chineseFont : englishFont) : singleFont;
                ctx.font = `${fontSize}px ${font}`;
                ctx.fillText(char, x, stable_alphabetic_baseline + yOffset);
                x += ctx.measureText(char).width + letterSpacing;
            }
            if (rotate) ctx.restore();

            guideCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            if (showGuides) {
                guideCtx.lineWidth = 1;
                const drawLine = (y, color) => {
                    guideCtx.strokeStyle = color;
                    guideCtx.beginPath();
                    guideCtx.moveTo(0, y);
                    guideCtx.lineTo(canvasWidth, y);
                    guideCtx.stroke();
                };

                if (hasNonChinese(text)) {
                    const fontForEnglish = fontMode === 'dual' ? englishFont : singleFont;
                    guideCtx.font = `${fontSize}px ${fontForEnglish}`;
                    const metrics = guideCtx.measureText('gA');
                    const ascent = metrics.actualBoundingBoxAscent || fontSize * 0.8;
                    const descent = metrics.actualBoundingBoxDescent || fontSize * 0.2;
                    
                    const baseline = stable_alphabetic_baseline + englishYOffset;
                    const top = baseline - ascent;
                    const bottom = baseline + descent;
                    const middle = top + (ascent + descent) / 2;

                    [top, middle, bottom].forEach(y => drawLine(y, 'rgba(255, 0, 0, 0.5)'));
                }
                
                if (hasChinese(text)) {
                    const fontForChinese = fontMode === 'dual' ? chineseFont : singleFont;
                    guideCtx.font = `${fontSize}px ${fontForChinese}`;
                    const metrics = guideCtx.measureText('ä¸­');
                    const ascent = metrics.actualBoundingBoxAscent || fontSize * 0.8;
                    const descent = metrics.actualBoundingBoxDescent || fontSize * 0.2;

                    const baseline = stable_alphabetic_baseline + chineseYOffset;
                    const top = baseline - ascent;
                    const bottom = baseline + descent;
                    const middle = top + (ascent + descent) / 2;

                    [top, middle, bottom].forEach(y => drawLine(y, 'rgba(0, 0, 255, 0.5)'));
                }
            }
            
            document.getElementById('sizeInfo').textContent = `å°ºå¯¸: ${Math.round(canvasWidth)} Ã— ${Math.round(canvasHeight)} px | æ¨¡å¼: ${fontMode === 'dual' ? 'ä¸­è‹±åˆ†é›¢' : 'çµ±ä¸€å­—é«”'} ${rotate ? '| æ—‹è½‰180Â°' : ''}`;
        }

        // --- ä¸‹è¼‰å‡½æ•¸ ---
        async function downloadPNG() {
            const finalCanvas = document.createElement('canvas');
            const finalCtx = finalCanvas.getContext('2d');
            const textCanvas = document.getElementById('textCanvas');
            
            finalCanvas.width = textCanvas.width;
            finalCanvas.height = textCanvas.height;
            finalCtx.drawImage(textCanvas, 0, 0);

            const shippingNumber = document.getElementById('shippingNumberInput').value.trim();
            const text = document.getElementById('textInput').value;
            const date = new Date();
            const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
            const timeStr = `${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}${String(date.getSeconds()).padStart(2, '0')}`;
            const timestamp = `${dateStr}${timeStr}`;
            const safeText = text.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_').substring(0, 15);
            
            const filenamePrefix = shippingNumber ? `${shippingNumber}_` : '';
            const filename = `${filenamePrefix}${safeText}_${timestamp}.png`;
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = finalCanvas.toDataURL("image/png");
            link.click();
        }
    </script>
</body>
</html>
