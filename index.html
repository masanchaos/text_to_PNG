<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—è½‰PNGè½‰æ›å™¨</title>
    <style>
        /* è¼‰å…¥æ‚¨æŒ‡å®šçš„ .woff2 æ ¼å¼å­—é«” */
        @font-face {
          font-family: 'Rage Italic';
          src: url('./fonts/RageItalic.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Avenir Next Condensed';
          src: url('./fonts/AvenirNextCondensed.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Taipei Sans TC Beta';
          src: url('./fonts/TaipeiSansTCBeta.woff2') format('woff2');
        }
        @font-face {
          font-family: 'Noto Sans CJK TC';
          src: url('./fonts/NotoSansCJKtc.woff2') format('woff2');
        }
        @font-face {
          font-family: 'å¾®è»Ÿæ­£é»‘é«”';
          src: url('./fonts/MicrosoftJhengHei.woff2') format('woff2');
        }

        /* é€šç”¨æ¨£å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans CJK TC', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; padding: 20px; background: #f8f9ff; border-radius: 10px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-top: 5px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .info-box { padding: 10px; background: #fff8e1; border-radius: 8px; font-size: 13px; color: #f57c00; margin-top: 15px; }
        .char-counter { text-align: right; font-size: 14px; margin-top: 5px; color: #666; }
        .char-counter.error { color: #ff5252; font-weight: bold; }
        .checkbox-group { display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-top: 10px; }
        input[type="checkbox"] { width: auto; margin-right: 8px; }
        #canvas { border: 2px solid #e0e0e0; border-radius: 8px; max-width: 100%; display: block; margin: 20px auto; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; }
        .font-mode-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .font-mode-btn { flex: 1; padding: 10px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .font-mode-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .font-settings { display: none; }
        .font-settings.active { display: block; }
        
        /* æ¨¡æ¿æ¨£å¼ */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 15px; }
        .template-card { padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer; text-align: center; transition: all 0.3s; position: relative; min-height: 140px; }
        .template-card:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .template-card.active { border-color: #667eea; background: #f0f2ff; }
        .add-template-card { padding: 15px; background: #fff; border: 2px dashed #667eea; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; }
        .add-template-card:hover { background: #f0f2ff; border-color: #764ba2; transform: translateY(-2px); }
        .delete-btn, .edit-btn { position: absolute; top: 5px; width: 24px; height: 24px; border-radius: 50%; border: none; cursor: pointer; display: none; color: white; font-size: 12px; }
        .delete-btn { right: 5px; background: #ff5252; }
        .edit-btn { right: 35px; background: #667eea; }
        .template-card:hover .delete-btn, .template-card:hover .edit-btn { display: block; }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 3% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœ¨ æ–‡å­—è½‰PNGè½‰æ›å™¨</h1>
            <p>è‡ªå®šç¾©æ¨¡æ¿ â€¢ 22å­—å…ƒé™åˆ¶ â€¢ é€æ˜èƒŒæ™¯ â€¢ ä¸­è‹±åˆ†é›¢å­—é«”</p>
        </div>

        <div class="content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title">ğŸ¨ è‡ªå®šç¾©æ¨¡æ¿</div>
                    <div>
                        <button class="btn btn-secondary" onclick="exportTemplates()">ğŸ“¤ åŒ¯å‡º</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="margin: 0 10px;">ğŸ“¥ åŒ¯å…¥</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTemplates(event)">
                        <button class="btn btn-primary" onclick="openTemplateModal()">+ æ–°å¢æ¨¡æ¿</button>
                    </div>
                </div>
                <div class="template-grid" id="templateGrid">
                    <div class="add-template-card" onclick="openTemplateModal()">
                        <div style="font-size: 48px; color: #667eea;">+</div>
                        <div style="color: #667eea; margin-top: 10px;">æ–°å¢æ¨¡æ¿</div>
                    </div>
                </div>
                <div class="info-box">ğŸ’¡ <strong>æç¤ºï¼š</strong>é»æ“Šæ¨¡æ¿å¥—ç”¨æ‰€æœ‰è¨­å®šï¼Œå†æ¬¡é»æ“Šå–æ¶ˆé¸æ“‡ã€‚ç•¶å‰ä½¿ç”¨æ¨¡æ¿ï¼š<span id="currentTemplate">ç„¡</span></div>
            </div>

            <div class="section">
                <div class="section-title">è¼¸å…¥æ–‡å­—ï¼ˆæœ€å¤š22å­—å…ƒï¼‰</div>
                <textarea id="textInput" placeholder="è«‹è¼¸å…¥è¦è½‰æ›çš„æ–‡å­—..." maxlength="50" style="height: 100px;">Hello, ä¸–ç•Œ!</textarea>
                <div class="char-counter" id="charCounter">10 / 22</div>
            </div>

            <div class="section">
                <div class="section-title">å­—é«”è¨­å®š</div>
                <div class="font-mode-toggle">
                    <button class="font-mode-btn active" onclick="switchFontMode('single', event)">çµ±ä¸€å­—é«”</button>
                    <button class="font-mode-btn" onclick="switchFontMode('dual', event)">ä¸­è‹±åˆ†é›¢</button>
                </div>
                <div id="singleFontSettings" class="font-settings active">
                    <div>
                        <label>å­—é«”</label>
                        <select id="fontFamily">
                            <option value="'Rage Italic', cursive">Rage Italic</option>
                            <option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option>
                            <option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option>
                            <option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option>
                            <option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
                            <option value="Arial, sans-serif">Arial (ç³»çµ±)</option>
                        </select>
                    </div>
                </div>
                <div id="dualFontSettings" class="font-settings">
                    <div class="grid-2">
                        <div>
                            <label>è‹±æ–‡å­—é«”</label>
                            <select id="englishFont">
                                <option value="'Rage Italic', cursive">Rage Italic</option>
                                <option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option>
                                <option value="Arial, sans-serif">Arial (ç³»çµ±)</option>
                            </select>
                        </div>
                        <div>
                            <label>ä¸­æ–‡å­—é«”</label>
                            <select id="chineseFont">
                                <option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option>
                                <option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option>
                                <option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">è¼¸å‡ºè¨­å®š</div>
                <div class="grid-2">
                    <div><label>å­—ç´š (px)</label><input type="number" id="fontSize" value="42.34" min="8" max="200" step="0.01"></div>
                    <div><label>å­—è· (px)</label><input type="number" id="letterSpacing" value="15" min="-10" max="500"></div>
                    <div id="heightInputContainer" style="display: none;"><label>é«˜åº¦ (px)</label><input type="number" id="height" value="53" min="20" max="500"></div>
                    <div><label>æ–‡å­—é¡è‰²</label><input type="color" id="textColor" value="#000000"></div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rotate180"><label for="rotate180">æ—‹è½‰180åº¦</label>
                </div>
                <div class="info-box">ğŸ“Œ <strong>è¼¸å‡ºèªªæ˜ï¼š</strong>PNGå°‡ä½¿ç”¨é€æ˜èƒŒæ™¯ï¼Œé è¦½ä¸­çš„æ ¼å­åªæ˜¯é¡¯ç¤ºé€æ˜æ•ˆæœã€‚</div>
            </div>

            <div class="section">
                <div class="section-title">é è¦½</div>
                <canvas id="canvas"></canvas>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;" id="sizeInfo">å°ºå¯¸è³‡è¨Š</div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="updateCanvas()" style="margin-right: 10px;">æ›´æ–°é è¦½</button>
                    <button class="btn btn-primary" id="downloadBtn" onclick="downloadPNG()">ä¸‹è¼‰ PNG</button>
                </div>
            </div>
        </div>
    </div>

    <div id="templateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">ğŸ“ æ¨¡æ¿è¨­å®š</h2>
            <input type="hidden" id="editIndex" value="-1">
            <div style="margin-bottom: 15px;"><label>æ¨¡æ¿åç¨± *</label><input type="text" id="templateName" placeholder="ä¾‹å¦‚ï¼šç¶²ç«™æ¨™é¡Œ"></div>
            <div style="margin-bottom: 15px;"><label>å­—é«”æ¨¡å¼</label><select id="templateFontMode"><option value="single">çµ±ä¸€å­—é«”</option><option value="dual">ä¸­è‹±åˆ†é›¢</option></select></div>
            <div style="margin-bottom: 15px;">
                <label>çµ±ä¸€å­—é«”ï¼ˆçµ±ä¸€æ¨¡å¼ç”¨ï¼‰</label>
                <select id="templateSingleFont">
                    <option value="'Rage Italic', cursive">Rage Italic</option>
                    <option value="'Avenir Next Condensed', sans-serif">Avenir Next Condensed</option>
                    <option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option>
                    <option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option>
                    <option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
                    <option value="Arial, sans-serif">Arial (ç³»çµ±)</option>
                </select>
            </div>
            <div class="grid-2" style="margin-bottom: 15px;">
                <div>
                    <label>è‹±æ–‡å­—é«”ï¼ˆåˆ†é›¢æ¨¡å¼ç”¨ï¼‰</label>
                    <select id="templateEnglishFont">
                        <option value="'Rage Italic', cursive">Rage Italic</option>
                        <option value="'Avenir Next Condensed', sans-serif" selected>Avenir Next Condensed</option>
                        <option value="Arial, sans-serif">Arial (ç³»çµ±)</option>
                    </select>
                </div>
                <div>
                    <label>ä¸­æ–‡å­—é«”ï¼ˆåˆ†é›¢æ¨¡å¼ç”¨ï¼‰</label>
                    <select id="templateChineseFont">
                        <option value="'Taipei Sans TC Beta', sans-serif">Taipei Sans TC Beta</option>
                        <option value="'Noto Sans CJK TC', sans-serif" selected>Noto Sans CJK TC</option>
                        <option value="'å¾®è»Ÿæ­£é»‘é«”', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
                    </select>
                </div>
            </div>
            <div class="grid-2" style="margin-bottom: 15px;">
                <div><label>å­—ç´š (px)</label><input type="number" id="templateFontSize" value="42.34" step="0.01"></div>
                <div><label>å­—è· (px)</label><input type="number" id="templateLetterSpacing" value="15"></div>
                <div><label>æ–‡å­—é¡è‰²</label><input type="color" id="templateTextColor" value="#000000"></div>
            </div>
            <div style="margin-bottom: 15px;"><input type="checkbox" id="templateRotate"><label for="templateRotate">æ—‹è½‰180åº¦</label></div>
            <div style="margin-bottom: 15px;"><label>æè¿°ï¼ˆé¸å¡«ï¼‰</label><input type="text" id="templateDesc" placeholder="ä¾‹å¦‚ï¼šé©ç”¨æ–¼ä¸»æ¨™é¡Œ"></div>
            <div style="margin-top: 20px;"><button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button><button class="btn btn-secondary" onclick="closeModal()" style="margin-left: 10px;">å–æ¶ˆ</button></div>
        </div>
    </div>

    <script>
        let templates = []; let fontMode = 'single'; let currentTemplateName = null;
        
        window.onload = async function() {
            await loadTemplates();
            updateCanvas();
            checkCharCount();
            
            document.getElementById('textInput').addEventListener('input', () => { checkCharCount(); updateCanvas(); });
            document.getElementById('fontSize').addEventListener('input', updateCanvas);
            document.getElementById('letterSpacing').addEventListener('input', updateCanvas);
            document.getElementById('textColor').addEventListener('input', updateCanvas);
            document.getElementById('fontFamily').addEventListener('change', updateCanvas);
            document.getElementById('englishFont').addEventListener('change', updateCanvas);
            document.getElementById('chineseFont').addEventListener('change', updateCanvas);
            document.getElementById('rotate180').addEventListener('change', updateCanvas);
        };

        function switchFontMode(mode, event) {
            fontMode = mode;
            document.querySelectorAll('.font-mode-btn').forEach(btn => btn.classList.remove('active'));
            if (event) event.target.classList.add('active');
            document.getElementById('singleFontSettings').classList.toggle('active', mode === 'single');
            document.getElementById('dualFontSettings').classList.toggle('active', mode === 'dual');
            updateCanvas();
        }
        function isChinese(char) { const code = char.charCodeAt(0); return (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF) || (code >= 0x3000 && code <= 0x303F) || (code >= 0xFF00 && code <= 0xFFEF) || (code >= 0x3040 && code <= 0x309F) || (code >= 0x30A0 && code <= 0x30FF) || (code >= 0xAC00 && code <= 0xD7AF); }
        
        async function loadTemplates() {
            const saved = localStorage.getItem('pngTemplates');
            if (saved) {
                console.log('å¾ localStorage è¼‰å…¥æ¨¡æ¿ã€‚');
                templates = JSON.parse(saved);
                renderTemplates();
                return;
            }

            try {
                // --- é€™æ˜¯é—œéµçš„ä¿®æ”¹: ä½¿ç”¨ './' ç›¸å°è·¯å¾‘ ---
                const response = await fetch('./templates.json');
                if (response.ok) {
                    const rootTemplates = await response.json();
                    if (Array.isArray(rootTemplates) && rootTemplates.length > 0) {
                        console.log('å¾æ ¹ç›®éŒ„ templates.json å°å…¥æ¨¡æ¿ã€‚');
                        templates = rootTemplates;
                        saveTemplatesLocal();
                        renderTemplates();
                        return;
                    }
                } else {
                    console.log("æœªåœ¨æ ¹ç›®éŒ„æ‰¾åˆ° templates.jsonï¼Œç‹€æ…‹ç¢¼:", response.status);
                }
            } catch (error) {
                console.log("è®€å– templates.json å¤±æ•—:", error);
            }
            
            console.log('ä½¿ç”¨é è¨­æ¨¡æ¿ã€‚');
            templates = [{ name: 'æ¨™æº–æ¨¡æ¿', fontSize: 42.34, letterSpacing: 15, fontMode: 'single', singleFont: "'Noto Sans CJK TC', sans-serif", textColor: '#000000', rotate: false, desc: 'é è¨­æ¨™æº–æ¨¡æ¿' }];
            saveTemplatesLocal();
            renderTemplates();
        }

        function saveTemplatesLocal() { localStorage.setItem('pngTemplates', JSON.stringify(templates)); }
        function renderTemplates() {
            const grid = document.getElementById('templateGrid');
            grid.innerHTML = `<div class="add-template-card" onclick="openTemplateModal()"><div style="font-size: 48px; color: #667eea;">+</div><div style="color: #667eea; margin-top: 10px;">æ–°å¢æ¨¡æ¿</div></div>`;
            templates.forEach((template, index) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                if (template.name === currentTemplateName) card.classList.add('active');
                card.innerHTML = `<button class="edit-btn" onclick="editTemplate(${index}); event.stopPropagation();">âœ</button><button class="delete-btn" onclick="deleteTemplate(${index}); event.stopPropagation();">Ã—</button><div style="font-weight: bold; margin-bottom: 5px;">${template.name}</div><div style="font-size: 12px; color: #666;">${template.fontSize}px | å­—è·${template.letterSpacing}px<br>${template.fontMode === 'dual' ? 'ä¸­è‹±åˆ†é›¢' : 'çµ±ä¸€å­—é«”'}${template.rotate ? '<br>æ—‹è½‰180Â°' : ''}${template.desc ? '<br>' + template.desc : ''}</div>`;
                card.onclick = () => applyTemplate(template);
                grid.appendChild(card);
            });
        }
        function openTemplateModal() {
            document.getElementById('templateModal').style.display = 'block';
            document.getElementById('editIndex').value = '-1';
            document.getElementById('templateName').value = '';
            document.getElementById('templateFontSize').value = document.getElementById('fontSize').value;
            document.getElementById('templateLetterSpacing').value = document.getElementById('letterSpacing').value;
            document.getElementById('templateFontMode').value = fontMode;
            document.getElementById('templateSingleFont').value = document.getElementById('fontFamily').value;
            document.getElementById('templateEnglishFont').value = document.getElementById('englishFont').value;
            document.getElementById('templateChineseFont').value = document.getElementById('chineseFont').value;
            document.getElementById('templateTextColor').value = document.getElementById('textColor').value;
            document.getElementById('templateRotate').checked = document.getElementById('rotate180').checked;
            document.getElementById('templateDesc').value = '';
        }
        function closeModal() { document.getElementById('templateModal').style.display = 'none'; }
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±'); return; }
            const template = {
                name: name,
                fontSize: parseFloat(document.getElementById('templateFontSize').value),
                letterSpacing: parseInt(document.getElementById('templateLetterSpacing').value),
                fontMode: document.getElementById('templateFontMode').value,
                singleFont: document.getElementById('templateSingleFont').value,
                englishFont: document.getElementById('templateEnglishFont').value,
                chineseFont: document.getElementById('templateChineseFont').value,
                textColor: document.getElementById('templateTextColor').value,
                rotate: document.getElementById('templateRotate').checked,
                desc: document.getElementById('templateDesc').value.trim()
            };
            const editIndex = parseInt(document.getElementById('editIndex').value);
            if (editIndex >= 0) { templates[editIndex] = template; } else { templates.push(template); }
            saveTemplatesLocal(); renderTemplates(); closeModal(); alert('æ¨¡æ¿å·²å„²å­˜ï¼');
        }
        function editTemplate(index) {
            const template = templates[index];
            document.getElementById('templateModal').style.display = 'block';
            document.getElementById('editIndex').value = index;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateFontSize').value = template.fontSize;
            document.getElementById('templateLetterSpacing').value = template.letterSpacing;
            document.getElementById('templateFontMode').value = template.fontMode || 'single';
            document.getElementById('templateSingleFont').value = template.singleFont || "'Noto Sans CJK TC', sans-serif";
            document.getElementById('templateEnglishFont').value = template.englishFont || "'Avenir Next Condensed', sans-serif";
            document.getElementById('templateChineseFont').value = template.chineseFont || "'Noto Sans CJK TC', sans-serif";
            document.getElementById('templateTextColor').value = template.textColor || '#000000';
            document.getElementById('templateRotate').checked = template.rotate || false;
            document.getElementById('templateDesc').value = template.desc || '';
        }
        function deleteTemplate(index) { if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡æ¿å—ï¼Ÿ')) { templates.splice(index, 1); saveTemplatesLocal(); renderTemplates(); } }
        function applyTemplate(template) {
            if (currentTemplateName === template.name) { currentTemplateName = null; document.getElementById('currentTemplate').textContent = 'ç„¡'; renderTemplates(); alert('å·²å–æ¶ˆé¸æ“‡æ¨¡æ¿'); return; }
            document.getElementById('fontSize').value = template.fontSize;
            document.getElementById('letterSpacing').value = template.letterSpacing;
            document.getElementById('textColor').value = template.textColor || '#000000';
            document.getElementById('rotate180').checked = template.rotate || false;
            const fontModeToApply = template.fontMode || 'single';
            const modeButtonIndex = fontModeToApply === 'dual' ? 1 : 0;
            document.querySelectorAll('.font-mode-btn')[modeButtonIndex].click();
            if (fontModeToApply === 'dual') {
                document.getElementById('englishFont').value = template.englishFont || "'Avenir Next Condensed', sans-serif";
                document.getElementById('chineseFont').value = template.chineseFont || "'Noto Sans CJK TC', sans-serif";
            } else {
                document.getElementById('fontFamily').value = template.singleFont || "'Noto Sans CJK TC', sans-serif";
            }
            currentTemplateName = template.name;
            document.getElementById('currentTemplate').textContent = template.name;
            renderTemplates();
            updateCanvas();
            alert(`å·²å¥—ç”¨æ¨¡æ¿ï¼š${template.name}`);
        }
        function exportTemplates() { if (templates.length === 0) { alert('æ²’æœ‰å¯åŒ¯å‡ºçš„æ¨¡æ¿'); return; } const dataStr = JSON.stringify(templates, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `templates-${Date.now()}.json`; link.click(); URL.revokeObjectURL(url); }
        function importTemplates(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const imported = JSON.parse(e.target.result); if (Array.isArray(imported)) { templates = templates.concat(imported); saveTemplatesLocal(); renderTemplates(); alert('æ¨¡æ¿åŒ¯å…¥æˆåŠŸï¼'); } else { alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ç„¡æ•ˆ'); } } catch (error) { alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; reader.readAsText(file); event.target.value = ''; }
        function checkCharCount() { const text = document.getElementById('textInput').value; const count = text.length; const counter = document.getElementById('charCounter'); const downloadBtn = document.getElementById('downloadBtn'); counter.textContent = `${count} / 22`; if (count > 22) { counter.className = 'char-counter error'; downloadBtn.disabled = true; } else { counter.className = 'char-counter'; downloadBtn.disabled = false; } }
        
        function updateCanvas() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const text = document.getElementById('textInput').value || 'Hello, ä¸–ç•Œ!';
            const fontSize = parseFloat(document.getElementById('fontSize').value);
            const letterSpacing = parseInt(document.getElementById('letterSpacing').value);
            const textColor = document.getElementById('textColor').value;
            const rotate = document.getElementById('rotate180').checked;
            const singleFont = document.getElementById('fontFamily').value;
            const englishFont = document.getElementById('englishFont').value;
            const chineseFont = document.getElementById('chineseFont').value;

            let totalWidth = 0;
            let maxAscent = 0;
            let maxDescent = 0;
            
            if (text.length > 0) {
                // ç¬¬ä¸€æ¬¡éæ­·ï¼šè¨ˆç®—ç¸½å¯¬åº¦å’Œç²å–æœ€å¤§å­—é«˜å’Œå­—æ·±
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const font = fontMode === 'dual' ? (isChinese(char) ? chineseFont : englishFont) : singleFont;
                    ctx.font = `${fontSize}px ${font}`;
                    const metrics = ctx.measureText(char);
                    
                    const ascent = metrics.actualBoundingBoxAscent || fontSize * 0.8;
                    const descent = metrics.actualBoundingBoxDescent || fontSize * 0.2;
                    
                    totalWidth += metrics.width;
                    maxAscent = Math.max(maxAscent, ascent);
                    maxDescent = Math.max(maxDescent, descent);
                }
                totalWidth += letterSpacing * (text.length - 1);
            }

            const horizontalPadding = 5;
            const verticalPadding = 4;
            
            const dynamicHeight = maxAscent + maxDescent + verticalPadding;
            canvas.width = (totalWidth > 0 ? totalWidth : 1) + horizontalPadding;
            canvas.height = dynamicHeight > 0 ? dynamicHeight : 1;
            
            if (rotate) {
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(Math.PI);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);
            }
            
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = textColor;
            
            let x = horizontalPadding / 2;
            const yBaseline = maxAscent + (verticalPadding / 2);
            
            // ç¬¬äºŒæ¬¡éæ­·ï¼šç¹ªè£½æ–‡å­—
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const font = fontMode === 'dual' ? (isChinese(char) ? chineseFont : englishFont) : singleFont;
                ctx.font = `${fontSize}px ${font}`;
                ctx.fillText(char, x, yBaseline);
                x += ctx.measureText(char).width + letterSpacing;
            }
            
            if (rotate) { ctx.restore(); }
            
            document.getElementById('sizeInfo').textContent = `å°ºå¯¸: ${Math.round(canvas.width)} Ã— ${Math.round(canvas.height)} px | æ¨¡å¼: ${fontMode === 'dual' ? 'ä¸­è‹±åˆ†é›¢' : 'çµ±ä¸€å­—é«”'} ${rotate ? '| æ—‹è½‰180Â°' : ''}`;
        }

        function downloadPNG() {
            const text = document.getElementById('textInput').value;
            if (text.length > 22) { alert('æ–‡å­—è¶…é22å€‹å­—å…ƒï¼Œç„¡æ³•ä¸‹è¼‰ï¼'); return; }
            if (text.length === 0) { alert('è«‹è¼¸å…¥æ–‡å­—å¾Œå†ä¸‹è¼‰ï¼'); return; }
            const canvas = document.getElementById('canvas');
            const date = new Date();
            const dateStr = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
            const timeStr = `${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}`;
            const safeText = text.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_').substring(0, 15);
            let filename;
            if (currentTemplateName) {
                filename = `${currentTemplateName}_${safeText}_${dateStr}_${timeStr}.png`;
            } else {
                const fontSize = document.getElementById('fontSize').value;
                const letterSpacing = document.getElementById('letterSpacing').value;
                const rotate = document.getElementById('rotate180').checked ? '_R180' : '';
                filename = `${safeText}_${fontSize}px_S${letterSpacing}${rotate}_${dateStr}_${timeStr}.png`;
            }
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }
        window.onclick = function(event) { const modal = document.getElementById('templateModal'); if (event.target == modal) { closeModal(); } }
    </script>
</body>
</html>
